# Research: Analyze Command Implementation

**Date**: 2025-12-08
**Purpose**: Verify directory structure and implementation patterns before creating an implementation plan for the analyze command

---

## Executive Summary

**CRITICAL FINDING**: The planned analyze command assumes data is stored in `corpus/` directory, but the actual implementation uses `writing/content/{platform}/` directories. The `corpus/` directory exists but is completely unused by the current codebase.

### Key Takeaways
- âœ… Directory structure: Use `writing/content/{platform}/` NOT `corpus/{platform}/`
- âœ… Existing utilities available: `listMarkdownFiles()`, `readMarkdown()`, `getPath()`, `countWords()`
- âœ… Frontmatter conventions: All metadata in YAML frontmatter (title, date, platform, word_count, tags, summary, url)
- âœ… Prompt management: Load with `loadPrompt()`, interpolate with `interpolate()`, complete with `complete()`
- âš ï¸ Plan needs updating: Change references from `corpus/` to `writing/content/`

---

## Directory Structure Analysis

### Current Implementation (Actual)

```
writing/
â”œâ”€â”€ import/              â† Users drop raw files here
â”œâ”€â”€ raw/                 â† Not actively used
â”œâ”€â”€ drafts/              â† Ingest outputs here (with frontmatter)
â””â”€â”€ content/             â† Final "published" location (after user review)
    â”œâ”€â”€ blog/            â† Blog posts ready for analysis
    â”œâ”€â”€ linkedin/        â† LinkedIn posts ready for analysis
    â”œâ”€â”€ substack/        â† Substack articles ready for analysis
    â””â”€â”€ twitter/         â† Tweets ready for analysis

corpus/                  â† EXISTS BUT UNUSED (legacy/experimental)
â”œâ”€â”€ linkedin/            â† Empty
â””â”€â”€ substack/            â† Empty
```

**Location**:
- Init command creates: `src/commands/init.ts:9-19`
- Ingest writes to: `src/commands/ingest.ts:100`

### Workflow

1. **Ingest**: `writing/import/` â†’ (LLM extraction) â†’ `writing/drafts/` with frontmatter
2. **Review**: User manually checks `writing/drafts/`
3. **Publish**: User moves files to `writing/content/{platform}/`
4. **Analyze**: Should read from `writing/content/{platform}/`

### File Organization

**Filename Pattern**: `YYYY-MM-DD_slug.md`
- Example: `2025-12-08_my-first-article.md`
- Generated by: `src/commands/ingest.ts:64-68`

**Frontmatter Structure**:
```yaml
---
title: "Article Title"
date: 2025-12-08
platform: blog
word_count: 450
tags: [productivity, writing, ai]
summary: "Brief 1-2 sentence summary"
url: "https://example.com/post"  # Optional
---

[Article content...]
```

**Type Definition**: `src/types.ts:15-23`

---

## Key Files & Locations

| File | Purpose | Key Exports/Functions |
|------|---------|----------------------|
| **Commands** |
| `src/commands/init.ts` | Initialize workspace | `init()` - Creates directory structure |
| `src/commands/ingest.ts` | Import writing samples | `ingest(dir, options)` - Extract metadata via LLM |
| **Libraries** |
| `src/lib/files.ts` | File operations | `listMarkdownFiles()`, `readMarkdown()`, `writeMarkdown()`, `getPath()`, `countWords()`, `slugify()` |
| `src/lib/llm.ts` | LLM client abstraction | `getLLMClient()`, `complete(prompt, options)` |
| `src/lib/prompts.ts` | Prompt management | `loadPrompt(name)`, `interpolate(template, context)` |
| `src/lib/config.ts` | Configuration | `loadConfig()`, `getProjectRoot()`, `findProjectRoot()` |
| **Types** |
| `src/types.ts` | Type definitions | `Platform`, `ClaudePenConfig`, `ArticleFrontmatter`, `RefinePass` |
| **Prompts** |
| `src/prompts/ingest.md` | Metadata extraction | Used by ingest command |

---

## Code Patterns to Follow

### 1. Command Structure

**Import Pattern**:
```typescript
// External dependencies first
import chalk from 'chalk';
import ora from 'ora';

// Internal types
import type { Platform } from '../types.js';

// Internal utilities
import { listMarkdownFiles, readMarkdown, getPath } from '../lib/files.js';
import { loadPrompt, interpolate } from '../lib/prompts.js';
import { complete } from '../lib/llm.js';
```

**Error Handling**:
```typescript
// Example from src/commands/ingest.ts:125-132
if (!validPlatforms.includes(platform)) {
  console.error(chalk.red(`Invalid platform: ${platform}`));
  console.error(`Valid options: ${validPlatforms.join(', ')}`);
  process.exit(1);
}
```

**Spinner Usage**:
```typescript
// Example from src/commands/ingest.ts:160-180
const spinner = ora(`Processing ${filename}`).start();

try {
  const result = await processFile(filePath);
  spinner.succeed(`${filename} â†’ success`);
} catch (error) {
  spinner.fail(`${filename} - failed`);
  console.error(chalk.dim(`  ${error}`));
}
```

**CLI Output**:
```typescript
// Example from src/commands/ingest.ts:183-190
console.log(chalk.bold('\nðŸ“Š Summary'));
console.log(`  Ingested: ${chalk.green(ingested)}`);
console.log(`  Skipped:  ${chalk.yellow(skipped)}`);
console.log(`  Failed:   ${chalk.red(failed)}`);

console.log(chalk.cyan('\nNext: Review files in writing/drafts/'));
```

### 2. LLM Integration

**Load and Interpolate Prompts**:
```typescript
// Example from src/commands/ingest.ts:85-91
const promptTemplate = loadPrompt('ingest');
const prompt = interpolate(promptTemplate, { content });

const response = await complete(prompt, {
  system: 'You are a metadata extraction assistant.',
  maxTokens: 500,  // Lower for structured output
});
```

**Default Model and Tokens**:
- Model: `claude-sonnet-4-20250514` (from `src/lib/config.ts:13`)
- Default max_tokens: `4096` (from `src/lib/llm.ts:22`)
- Use 500-1000 for structured output
- Use 4000+ for content generation

**Client Access**:
```typescript
// Abstracted via src/lib/llm.ts:69-84
import { complete } from '../lib/llm.js';

// Automatically handles:
// - Loading config
// - Getting API key from environment
// - Creating client
// - Showing spinner
// - Error handling
```

### 3. File Operations

**Discover Files**:
```typescript
import { listMarkdownFiles, getPath } from '../lib/files.js';

const files = await listMarkdownFiles(getPath('writing', 'content', 'blog'));
// Returns: ['/absolute/path/to/file1.md', '/absolute/path/to/file2.md']
```

**Read Files with Frontmatter**:
```typescript
import { readMarkdown } from '../lib/files.js';

const { frontmatter, content } = readMarkdown(filePath);

// Access metadata
const title = frontmatter.title;              // string
const platform = frontmatter.platform;        // 'blog' | 'linkedin' | 'substack' | 'twitter'
const tags = frontmatter.tags;                // string[]
const wordCount = frontmatter.word_count;     // number
```

**Write Files with Frontmatter**:
```typescript
import { writeMarkdown, getPath } from '../lib/files.js';

const outputPath = getPath('writing', 'drafts', 'style_guide.md');
writeMarkdown(outputPath, frontmatter, content);
// Automatically creates parent directories
```

**Path Resolution**:
```typescript
import { getPath } from '../lib/files.js';

// Build paths relative to project root
const path = getPath('writing', 'content', 'blog');
// Returns: /absolute/path/to/project/writing/content/blog

// Throws error if not in initialized workspace
```

### 4. Prompt Management

**Loading Prompts**:
```typescript
import { loadPrompt } from '../lib/prompts.js';

// Priority: .claude-pen/prompts/ > src/prompts/
const template = loadPrompt('analyze');  // Looks for analyze.md
const subTemplate = loadPrompt('format/linkedin');  // Supports subdirs
```

**Interpolation**:
```typescript
import { interpolate } from '../lib/prompts.js';

const prompt = interpolate(template, {
  samples: formattedSamples,
  platform: 'blog',
});
// Replaces {{samples}} and {{platform}} in template
```

---

## Platform Handling

### Valid Platforms

From `src/types.ts:11`:
```typescript
type Platform = 'blog' | 'linkedin' | 'substack' | 'twitter'
```

### Platform Storage

**During Ingest**: Platform is stored in frontmatter
```yaml
platform: blog
```

**After Review**: Files are organized by directory
```
writing/content/blog/      â† Blog posts
writing/content/linkedin/  â† LinkedIn posts
writing/content/substack/  â† Substack articles
writing/content/twitter/   â† Tweets
```

### Platform Discovery

**Option A: Directory-based (Recommended)**
```typescript
const PLATFORMS: Platform[] = ['blog', 'linkedin', 'substack', 'twitter'];

for (const platform of PLATFORMS) {
  const platformDir = getPath('writing', 'content', platform);
  if (!fs.existsSync(platformDir)) continue;

  const files = await listMarkdownFiles(platformDir);
  // Process files...
}
```

**Option B: Frontmatter-based**
```typescript
const allFiles = await listMarkdownFiles(getPath('writing', 'content'));

for (const filePath of allFiles) {
  const { frontmatter, content } = readMarkdown(filePath);
  const platform = frontmatter.platform;
  // Filter by platform...
}
```

---

## Token Management

### LLM Token Limits

**Maximum Sample Size** (from Plan 5):
```typescript
const MAX_SAMPLE_TOKENS = 100000;  // ~100k tokens for input
const CHARS_PER_TOKEN = 4;         // Rough estimation
const MAX_SAMPLE_CHARS = MAX_SAMPLE_TOKENS * CHARS_PER_TOKEN;  // 400k chars
```

### Sampling Strategy

**Equal Distribution Across Platforms**:
```typescript
const platformCount = byPlatform.size;
const budgetPerPlatform = Math.floor(MAX_SAMPLE_CHARS / platformCount);

// Include samples from each platform up to budget
// Truncate last sample if it exceeds budget
```

**Logging**:
```typescript
console.log(chalk.dim(`  Including ${includedCount} of ${samples.length} samples (~${Math.round(totalChars / 1000)}k chars)`));
```

---

## Required Plan Changes

The original Plan 5 needs the following modifications to match the actual codebase structure:

### Change 1: Sample Collection Directory

**Original Plan 5 (Line 61-66)**:
```typescript
for (const platform of PLATFORMS) {
  const platformDir = getPath('corpus', platform);

  if (!fs.existsSync(platformDir)) {
    continue;
  }
```

**Required Change**:
```typescript
for (const platform of PLATFORMS) {
  const platformDir = getPath('writing', 'content', platform);  // Changed

  if (!fs.existsSync(platformDir)) {
    continue;
  }
```

**Rationale**: The codebase uses `writing/content/{platform}/` for published content, NOT `corpus/{platform}/`.

---

### Change 2: Style Guide Output Path

**Original Plan 5 (Line 11)**:
```typescript
const STYLE_GUIDE_PATH = 'corpus/_style_guide.md';
```

**Required Change**:
```typescript
const STYLE_GUIDE_PATH = 'writing/_style_guide.md';  // Changed
```

**Rationale**: Since `corpus/` is unused, keep the style guide with the writing samples at `writing/_style_guide.md`.

---

### Change 3: Empty Corpus Guidance

**Original Plan 5 (Lines 109-112)**:
```typescript
console.log(chalk.yellow('\nIngest some writing first:'));
console.log(chalk.cyan('  claude-pen ingest ./my-posts --platform blog'));
return;
```

**Required Change**:
```typescript
console.log(chalk.yellow('\nPublish some writing first:'));
console.log(chalk.cyan('  1. Ingest: claude-pen ingest ./my-posts --platform blog'));
console.log(chalk.cyan('  2. Review: Check writing/drafts/'));
console.log(chalk.cyan('  3. Publish: Move files to writing/content/blog/'));
return;
```

**Rationale**: Users need to complete the full workflow (ingest â†’ review â†’ publish) before content is available for analysis.

---

### Change 4: Success Message Path Reference

**Original Plan 5 (Line 140)**:
```typescript
console.log(chalk.green(`\nâœ“ Style guide saved to ${STYLE_GUIDE_PATH}`));
```

This will automatically update since `STYLE_GUIDE_PATH` changes from `corpus/_style_guide.md` to `writing/_style_guide.md`.

---

### Change 5: Update Final Verification Paths

**Original Plan 5 Manual Verification Section**:
```bash
# Ingest to different platforms, then analyze:
bun run src/index.ts ingest ./blog-posts --platform blog
bun run src/index.ts ingest ./linkedin-posts --platform linkedin
bun run src/index.ts analyze
```

**Required Change**:
```bash
# Complete workflow for different platforms:
# 1. Ingest
bun run src/index.ts ingest ./blog-posts --platform blog
bun run src/index.ts ingest ./linkedin-posts --platform linkedin

# 2. Review drafts
ls writing/drafts/

# 3. Publish to content directories
mv writing/drafts/*.md writing/content/blog/  # (or appropriate platform)

# 4. Analyze
bun run src/index.ts analyze
```

**Rationale**: Test instructions should reflect the complete workflow, including the manual publish step.

---

### Change 6: Add Import for fs Module

**Original Plan 5 (Lines 1-8)**:
```typescript
import fs from 'fs';
import path from 'path';
import chalk from 'chalk';
import ora from 'ora';
import { complete } from '../lib/llm.js';
import { listMarkdownFiles, readMarkdown, getPath } from '../lib/files.js';
import { loadPrompt, interpolate } from '../lib/prompts.js';
import type { Platform } from '../types.js';
```

This is correct - no change needed. Just verify that `fs` is imported for the `fs.existsSync()` call.

---

### Summary of Changes

| Section | Original Value | New Value |
|---------|---------------|-----------|
| Directory constant | `getPath('corpus', platform)` | `getPath('writing', 'content', platform)` |
| Style guide path | `corpus/_style_guide.md` | `writing/_style_guide.md` |
| Empty content message | "Ingest some writing first" | "Publish some writing first" (with 3-step workflow) |
| Verification steps | Ingest only | Ingest â†’ Review â†’ Publish â†’ Analyze |

---

## Recommendations for Implementation

### 1. Directory Paths

**Use**:
```typescript
writing/content/blog/
writing/content/linkedin/
writing/content/substack/
writing/content/twitter/
```

**NOT**:
```typescript
corpus/blog/          âŒ WRONG - unused directory
corpus/linkedin/      âŒ WRONG - unused directory
```

### 2. Output Location

**Style Guide Path**: `writing/_style_guide.md`

**Rationale**: Keep it at the writing/ level since it analyzes content from writing/content/

**Alternative**: The plan suggests `corpus/_style_guide.md`, but since corpus/ is unused, we should use `writing/_style_guide.md` instead.

### 3. Reuse Existing Utilities

âœ… Use `listMarkdownFiles()` for file discovery
âœ… Use `readMarkdown()` for parsing frontmatter + content
âœ… Use `getPath()` for path building
âœ… Use `countWords()` if needed for statistics
âœ… Use `complete()` for LLM interaction with spinner
âœ… Use `loadPrompt()` and `interpolate()` for prompt management

### 4. Follow Existing Patterns

âœ… Import order: external deps â†’ types â†’ utilities
âœ… Error handling: `chalk.red()` messages, `process.exit(1)`
âœ… Spinners: `ora()` with `.start()`, `.succeed()`, `.fail()`
âœ… Output: `chalk.bold()` headers, color-coded results, `chalk.cyan()` next steps
âœ… File operations: Always use `getPath()` for paths, `ensureDir()` before writes

### 5. Empty Content Handling

**Check for empty content directories**:
```typescript
const samples = await collectSamples();

if (samples.length === 0) {
  spinner.fail('No writing samples found');
  console.log(chalk.yellow('\nPublish some writing first:'));
  console.log(chalk.cyan('  1. Ingest: claude-pen ingest --platform blog'));
  console.log(chalk.cyan('  2. Review: Check writing/drafts/'));
  console.log(chalk.cyan('  3. Publish: Move files to writing/content/blog/'));
  return;
}
```

---

## Potential Concerns

### 1. Token Budget

The plan allocates 100k tokens (~400k chars) for input samples. With Claude Sonnet 4, the context window is 200k tokens, so this is reasonable but needs careful monitoring.

**Mitigation**: Implement truncation per platform as shown in the plan.

### 2. Empty Platforms

Users may only have content in one platform (e.g., only blog posts).

**Mitigation**: Skip platforms with no files and only include platforms with content in the analysis.

### 3. Large Files

Individual articles may be very long and consume the entire budget.

**Mitigation**: Truncate individual samples if they exceed per-platform budget.

### 4. Style Guide Location

The plan puts the style guide at `corpus/_style_guide.md`, but `corpus/` is unused.

**Recommendation**: Change to `writing/_style_guide.md` to match actual directory structure.

---

## Code Examples from Codebase

### File Discovery Pattern
`src/commands/ingest.ts:142-143`
```typescript
const files = await listMarkdownFiles(sourceDir);
console.log(chalk.bold(`\nðŸ“¥ Ingesting ${files.length} files\n`));
```

### Reading with Frontmatter
`src/commands/ingest.ts:74`
```typescript
const { frontmatter, content } = readMarkdown(filePath);
```

### LLM Completion with Options
`src/commands/ingest.ts:87-91`
```typescript
const response = await complete(prompt, {
  system: 'You are a metadata extraction assistant.',
  maxTokens: 500,
});
```

### Writing with Frontmatter
`src/commands/ingest.ts:100-102`
```typescript
const outputPath = getPath('writing', 'drafts', newFilename);
writeMarkdown(outputPath, updatedFrontmatter, content);
```

### Summary Output
`src/commands/ingest.ts:183-191`
```typescript
console.log(chalk.bold('\nðŸ“Š Summary'));
console.log(`  Ingested: ${chalk.green(ingested)}`);
console.log(`  Skipped:  ${chalk.yellow(skipped)}`);
console.log(`  Failed:   ${chalk.red(failed)}`);

if (ingested > 0) {
  console.log(chalk.cyan('\nNext: Review files in writing/drafts/'));
}
```

---

## Next Steps

1. **Update Plan 5**: Change all references from `corpus/` to `writing/content/`
2. **Change style guide path**: From `corpus/_style_guide.md` to `writing/_style_guide.md`
3. **Update sample collection**: Read from `writing/content/{platform}/` not `corpus/{platform}/`
4. **Verify prompt location**: Create `src/prompts/analyze.md` (NOT `src/prompts/analyze/analyze.md`)
5. **Follow existing patterns**: Use utilities, error handling, spinners as documented above

---

## References

- Ingest command: `src/commands/ingest.ts`
- Init command: `src/commands/init.ts`
- File utilities: `src/lib/files.ts`
- LLM utilities: `src/lib/llm.ts`
- Prompt utilities: `src/lib/prompts.ts`
- Type definitions: `src/types.ts`
- Existing prompt: `src/prompts/ingest.md`
